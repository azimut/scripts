#!/bin/bash

set -euo pipefail

blocked_hosts=(
    "instagram.com"
    "okcupid.com"
    "reddit.com"
    "twitch.tv"
    "twitter.com"
    "youtube.com"
)

FOCUS_MSG="Time to FOCUS!!!"
UNFOCUS_MSG="Welcome back!"
HOSTS=/etc/dnsmasq.d/hosts/01-focus

notify(){ notify-send 'focus-mode' "$@"; }
add_host(){
    echo "0.0.0.0 ${1} www.${1}" | tee -a "${HOSTS}"
}
add_hosts(){
    for host in "${blocked_hosts[@]}"; do
        add_host "${host}"
    done
    notify "$FOCUS_MSG"
}
# NOTE: Return code for remove_host() is important
remove_host(){
    local old; old=$(stat --printf="%s" ${HOSTS})
    sed '/0.0.0.0.*\s'"${1}"'\s.*/d' "${HOSTS}" > temp
    cat temp > ${HOSTS}
    local new; new=$(stat --printf="%s" ${HOSTS})
    [[ ${old} -ne ${new} ]]
}
remove_hosts(){
    local r=1
    for host in "${blocked_hosts[@]}"; do
        if remove_host "$host"; then
            r=0
        fi
    done
    notify "$UNFOCUS_MSG"
    return $r
}

if ! remove_hosts; then
    add_hosts
fi
